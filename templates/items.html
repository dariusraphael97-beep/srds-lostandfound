{% extends "base.html" %}
{% block title %}Browse Items â€” SRDS Lost & Found{% endblock %}

{% block content %}

<header class="page-header" aria-labelledby="browse-heading">
  <div class="container">
    <div class="hero-eyebrow" style="display:inline-flex; margin-bottom:16px;">ğŸ“¦ Found Items Directory</div>
    <h1 id="browse-heading">Browse Lost &amp; Found</h1>
    <p>Search all items reported at Saddle River Day School.</p>
  </div>
</header>

<section class="section-sm">
  <div class="container">

    <!-- Notification signup -->
    <!-- SMS / Email Alert Signup -->
    <div class="reveal" style="background:rgba(74,127,212,0.08); border:1px solid rgba(74,127,212,0.2); border-radius:var(--radius); padding:22px 26px; margin-bottom:24px;">
      <div style="display:flex; gap:14px; align-items:flex-start; flex-wrap:wrap;">
        <div style="flex:1; min-width:220px;">
          <div style="display:flex; align-items:center; gap:10px; margin-bottom:4px;">
            <span style="font-size:1.1rem;" aria-hidden="true">ğŸ””</span>
            <strong style="color:var(--white); font-size:0.95rem;">Item Alert</strong>
            <span style="font-size:0.65rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; background:rgba(34,197,94,0.15); color:var(--success); border:1px solid rgba(34,197,94,0.25); padding:2px 8px; border-radius:100px;">SMS + Email</span>
          </div>
          <p style="font-size:0.82rem; margin:0; color:var(--white-40); line-height:1.5;">
            Enter a keyword and we'll alert you the moment a matching item is posted â€” by text and email.
          </p>
        </div>
        <form method="POST" action="{{ url_for('notify') }}"
              style="display:flex; gap:8px; flex-wrap:wrap; align-items:flex-end; flex:2; min-width:300px;">
          <div style="flex:1; min-width:140px;">
            <div style="font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--white-40); margin-bottom:5px;">Keyword *</div>
            <input type="text" name="keyword" placeholder="e.g. AirPods, backpackâ€¦" required
                   style="width:100%; padding:9px 14px; font-size:0.85rem; border-radius:var(--radius-sm); background:var(--white-05); border:1px solid var(--white-20); color:var(--white);"
                   aria-label="Keyword to watch for" />
          </div>
          <div style="flex:1; min-width:140px;">
            <div style="font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--white-40); margin-bottom:5px;">Email *</div>
            <input type="email" name="email" placeholder="you@srds.org" required
                   style="width:100%; padding:9px 14px; font-size:0.85rem; border-radius:var(--radius-sm); background:var(--white-05); border:1px solid var(--white-20); color:var(--white);"
                   aria-label="Your email address" />
          </div>
          <div style="flex:1; min-width:130px;">
            <div style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
              <div style="font-size:0.68rem; font-weight:700; text-transform:uppercase; letter-spacing:0.1em; color:var(--white-40);">Phone</div>
              <span style="font-size:0.6rem; color:var(--success); font-weight:600;">ğŸ“± for SMS</span>
            </div>
            <input type="tel" name="phone" placeholder="+1 (201) 555-0100"
                   style="width:100%; padding:9px 14px; font-size:0.85rem; border-radius:var(--radius-sm); background:var(--white-05); border:1px solid var(--white-20); color:var(--white);"
                   aria-label="Phone number for SMS alerts (optional)" />
          </div>
          <div>
            <div style="font-size:0.68rem; color:transparent; margin-bottom:5px;">go</div>
            <button type="submit" class="btn btn-primary btn-sm" style="white-space:nowrap;">Set Alert â†’</button>
          </div>
        </form>
      </div>
      <p style="font-size:0.72rem; color:var(--white-20); margin-top:12px; margin-bottom:0;">
        Phone number optional but required for SMS alerts. Standard message rates may apply. You can leave it blank for email-only.
      </p>
    </div>

    <!-- Search Bar -->
    <div class="search-bar reveal" role="search" aria-label="Search found items">
      <div class="search-field">
        <label for="searchInput">Search</label>
        <input type="text" id="searchInput" placeholder="e.g. blue backpack, AirPods, water bottleâ€¦" value="{{ search }}" autocomplete="off" aria-label="Search by keyword" />
      </div>
      <div class="search-field" style="max-width:210px;">
        <label for="categorySelect">Category</label>
        <select id="categorySelect" aria-label="Filter by category">
          <option value="">All Categories</option>
          {% set all_cats = ['Clothing & Apparel','Electronics','Books & Stationery','Bags & Backpacks','Sports Equipment','Jewelry & Accessories','Keys','Water Bottles','Other'] %}
          {% for cat in all_cats %}
            <option value="{{ cat }}" {% if cat == category %}selected{% endif %}>{{ cat }}</option>
          {% endfor %}
        </select>
      </div>
      <div>
        <label style="visibility:hidden; display:block; font-size:0.78rem;">Go</label>
        <button class="btn btn-primary btn-sm" id="searchBtn" type="button">ğŸ” Search</button>
      </div>
      {% if search or category %}
      <div>
        <label style="visibility:hidden; display:block; font-size:0.78rem;">Clear</label>
        <a href="{{ url_for('items') }}" class="btn btn-glass btn-sm">âœ• Clear</a>
      </div>
      {% endif %}
    </div>

    <!-- Result count -->
    <p style="margin-bottom:24px; color:var(--white-40); font-size:0.88rem;" aria-live="polite">
      {% if search or category %}
        <strong style="color:var(--white-70);">{{ items|length }}</strong> result{{ 's' if items|length != 1 }}
        {% if search %} for "<strong style="color:var(--accent);">{{ search }}</strong>"{% endif %}
        {% if category %} in <strong style="color:var(--accent);">{{ category }}</strong>{% endif %}
      {% else %}
        Showing <strong style="color:var(--white-70);">{{ items|length }}</strong> item{{ 's' if items|length != 1 }}
      {% endif %}
    </p>

    <!-- Items Grid -->
    {% if items %}
    <div class="items-grid" role="list" aria-label="Found items">
      {% for item in items %}
      <article class="card reveal reveal-delay-{{ (loop.index0 % 3) + 1 }}" role="listitem">
        <div class="card-img-wrap">
          {% if item.photo %}
            <img class="card-img" src="{{ url_for('uploaded_file', filename=item.photo) }}" alt="Photo of {{ item.name }}" loading="lazy" />
          {% elif item.photo_url %}
            <img class="card-img" src="{{ item.photo_url }}" alt="Photo of {{ item.name }}" loading="lazy" onerror="this.outerHTML='<div class=card-img-placeholder>'+(this.dataset.emoji||'ğŸ“¦')+'</div>'" data-emoji="{{ item.emoji }}" />
          {% else %}
            <div class="card-img-placeholder" aria-label="{{ item.category }} item">{{ item.emoji }}</div>
          {% endif %}
          <div class="card-img-overlay" aria-hidden="true"></div>
          <div style="position:absolute; top:10px; right:10px;"><span class="days-badge" data-found="{{ item.date_found }}">ğŸ• â€¦</span></div>
        </div>
        <div class="card-body">
          <span class="card-category">{{ item.category }}</span>
          <a href="{{ url_for('item_detail', item_id=item.id) }}" style="text-decoration:none;"><h3 class="card-title" style="transition:color var(--transition);" onmouseover="this.style.color='var(--accent)'" onmouseout="this.style.color=''">{{ item.name }}</h3></a>
          <div class="card-meta">
            <span>ğŸ“ {{ item.location }}</span>
            <span>ğŸ“… {{ item.date_found }}</span>
          </div>
          <p style="font-size:0.84rem; color:var(--white-40); margin-bottom:16px; line-height:1.5;">
            {{ item.description[:90] }}{% if item.description|length > 90 %}â€¦{% endif %}
          </p>
          <!-- Quantity unclaimed bar -->
          {% if item.quantity and item.quantity > 0 %}
          <div style="display:flex; align-items:center; justify-content:space-between; padding:9px 12px; background:rgba(74,127,212,0.07); border:1px solid rgba(74,127,212,0.15); border-radius:var(--radius-sm); margin-bottom:12px; font-size:0.78rem;">
            <span style="color:var(--white-70); font-weight:600;">
              <span style="color:var(--accent); font-size:1rem; font-weight:700; font-family:'Cormorant Garamond',serif;">{{ item.quantity }}</span>
              &nbsp;unclaimed item{{ 's' if item.quantity != 1 }}
            </span>
            {% if item.quantity == 1 %}
              <span style="color:var(--success); font-size:0.7rem; font-weight:600;">â— Available</span>
            {% else %}
              <span style="color:var(--warning); font-size:0.7rem; font-weight:600;">â— Multiple found</span>
            {% endif %}
          </div>
          {% endif %}
          <div class="card-actions">
            <a href="{{ url_for('item_detail', item_id=item.id) }}" class="btn btn-primary btn-sm">View Details</a>
            <a href="{{ url_for('claim', item_id=item.id) }}" class="btn btn-glass btn-sm">Claim</a>
            <button class="bookmark-btn" data-id="{{ item.id }}" aria-label="Bookmark {{ item.name }}" title="Save for later">ğŸ·ï¸</button>
          </div>
        </div>
      </article>
      {% endfor %}
    </div>

    {% else %}
    <div class="empty-state reveal" role="status">
      <div class="empty-icon" aria-hidden="true">ğŸ”</div>
      <h3>No items found</h3>
      <p>{% if search or category %}Try different keywords or clear your filters.{% else %}No approved items yet â€” check back soon!{% endif %}</p>
      {% if search or category %}<a href="{{ url_for('items') }}" class="btn btn-primary" style="margin-top:20px;">Clear Filters</a>{% endif %}
    </div>
    {% endif %}

  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const searchInput   = document.getElementById('searchInput');
  const categorySelect = document.getElementById('categorySelect');
  const searchBtn     = document.getElementById('searchBtn');

  function doSearch() {
    const q   = encodeURIComponent(searchInput.value.trim());
    const cat = encodeURIComponent(categorySelect.value);
    let url = "{{ url_for('items') }}";
    const p = [];
    if (q)   p.push(`q=${q}`);
    if (cat) p.push(`category=${cat}`);
    if (p.length) url += '?' + p.join('&');
    window.location.href = url;
  }

  searchBtn.addEventListener('click', doSearch);
  searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') doSearch(); });
  categorySelect.addEventListener('change', doSearch);

  // Days since badges
  document.querySelectorAll('.days-badge[data-found]').forEach(badge => {
    const days = Math.floor((new Date() - new Date(badge.dataset.found)) / 86400000);
    badge.classList.remove('fresh','old');
    if (days === 0)      { badge.textContent = 'ğŸ• Today';        badge.classList.add('fresh'); }
    else if (days <= 3)  { badge.textContent = `ğŸ• ${days}d ago`; badge.classList.add('fresh'); }
    else if (days <= 14) { badge.textContent = `ğŸ• ${days}d ago`; }
    else                 { badge.textContent = `ğŸ• ${days}d ago`; badge.classList.add('old'); }
  });
</script>
{% endblock %}
