{% extends "base.html" %}
{% block title %}Admin Dashboard â€” SRDS Lost & Found{% endblock %}

{% block content %}
<header class="page-header" aria-labelledby="admin-heading">
  <div class="container" style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px;">
    <div>
      <h1 id="admin-heading" style="font-size:2rem;">Admin Dashboard</h1>
      <p>Manage submissions, claims &amp; notifications.</p>
    </div>
    <a href="{{ url_for('admin_logout') }}" class="btn btn-glass btn-sm">Sign Out</a>
  </div>
</header>

<section class="section-sm">
  <div class="container">

    <!-- Twilio status banner -->
    {% if not twilio_configured %}
    <div style="background:rgba(245,158,11,0.08); border:1px solid rgba(245,158,11,0.25); border-radius:var(--radius-sm); padding:14px 20px; margin-bottom:28px; display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
      <span style="font-size:1.1rem;">ðŸ“±</span>
      <div style="flex:1;">
        <strong style="color:var(--warning); font-size:0.88rem;">SMS Alerts Not Configured</strong>
        <p style="font-size:0.8rem; color:var(--white-40); margin:2px 0 0;">
          Add <code style="color:var(--accent);">TWILIO_ACCOUNT_SID</code>, <code style="color:var(--accent);">TWILIO_AUTH_TOKEN</code>, and <code style="color:var(--accent);">TWILIO_PHONE_NUMBER</code> to your Railway environment variables to enable SMS alerts.
        </p>
      </div>
      <a href="https://twilio.com" target="_blank" rel="noopener" class="btn btn-glass btn-xs">Get Twilio â†’</a>
    </div>
    {% else %}
    <div style="background:rgba(34,197,94,0.06); border:1px solid rgba(34,197,94,0.2); border-radius:var(--radius-sm); padding:12px 20px; margin-bottom:28px; display:flex; gap:10px; align-items:center;">
      <span style="color:var(--success);">âœ“</span>
      <span style="font-size:0.85rem; color:var(--success); font-weight:600;">Twilio SMS is active â€” alerts will fire automatically when items are approved.</span>
    </div>
    {% endif %}

    <!-- Stats -->
    <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:16px; margin-bottom:40px;">
      {% for label, val, color in [
        ('Pending Items', pending_items|length, 'var(--warning)'),
        ('Live Items',    approved_items|length, 'var(--success)'),
        ('Claimed',       claimed_items|length,  'var(--accent)'),
        ('Pending Claims',pending_claims|length, 'var(--error)'),
        ('Notifications', notifications|length,  'var(--gray-300)')
      ] %}
      <div class="card reveal" style="padding:24px; text-align:center;">
        <div style="font-family:'Cormorant Garamond',serif; font-size:2.4rem; font-weight:700; color:{{ color }}; line-height:1;">{{ val }}</div>
        <div style="font-size:0.72rem; color:var(--white-40); font-weight:700; text-transform:uppercase; letter-spacing:.08em; margin-top:6px;">{{ label }}</div>
      </div>
      {% endfor %}
    </div>

    <!-- Tabs -->
    <div class="admin-tabs reveal" role="tablist">
      <button class="tab-btn active" role="tab" aria-selected="true"  aria-controls="tab-pending" id="btn-pending">
        {% if pending_items %}
        <span style="display:inline-block; width:8px; height:8px; border-radius:50%;
                     background:var(--warning); margin-right:6px;
                     animation:pulse 1.5s ease-in-out infinite; vertical-align:middle;"></span>
        {% endif %}
        Pending ({{ pending_items|length }})
      </button>
      <button class="tab-btn"        role="tab" aria-selected="false" aria-controls="tab-approved"      id="btn-approved">âœ“ Live ({{ approved_items|length }})</button>
      <button class="tab-btn"        role="tab" aria-selected="false" aria-controls="tab-claims"        id="btn-claims">ðŸ“¬ Claims ({{ pending_claims|length }})</button>
      <button class="tab-btn"        role="tab" aria-selected="false" aria-controls="tab-claimed"       id="btn-claimed">ðŸ“¦ Claimed ({{ claimed_items|length }})</button>
      <button class="tab-btn"        role="tab" aria-selected="false" aria-controls="tab-notifications" id="btn-notifs">ðŸ”” Alerts ({{ notifications|length }})</button>
      <button class="tab-btn"        role="tab" aria-selected="false" aria-controls="tab-sms"           id="btn-sms">ðŸ“± SMS Log ({{ sms_logs|length }})</button>
    </div>

    <!-- Pending Items -->
    <div class="tab-panel active card" id="tab-pending" role="tabpanel" aria-labelledby="btn-pending">
      {% if pending_items %}
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Item</th><th>Category</th><th>Location</th><th>Date Found</th><th>Reported By</th><th>Submitted</th><th>Actions</th></tr></thead>
          <tbody>
            {% for item in pending_items %}
            <tr style="{% if loop.first %}border-left:3px solid var(--warning);{% endif %}">
              <td style="color:var(--white-40);">#{{ item.id }}</td>
              <td>
                <strong style="color:var(--white);">{{ item.name }}</strong>
                {% if item.photo %}
                <br>
                <img src="{{ url_for('uploaded_file', filename=item.photo) }}"
                     alt="Photo" style="width:60px; height:45px; object-fit:cover;
                     border-radius:6px; margin-top:6px; border:1px solid var(--white-10);" />
                {% endif %}
              </td>
              <td><span class="badge badge-pending">{{ item.category }}</span></td>
              <td>{{ item.location }}</td>
              <td>{{ item.date_found }}</td>
              <td style="font-size:0.8rem;">{{ item.submitted }}</td>
              <td style="font-size:0.8rem;">
                {% if item.finder_name %}
                  <div style="color:var(--white-70);">{{ item.finder_name }}</div>
                  {% if item.finder_email %}
                  <a href="mailto:{{ item.finder_email }}" style="color:var(--accent); font-size:0.75rem;">{{ item.finder_email }}</a>
                  {% endif %}
                {% else %}
                  <span style="color:var(--white-20);">â€”</span>
                {% endif %}
              </td>
              <td style="display:flex; gap:6px; flex-wrap:wrap;">
                <form method="POST" action="{{ url_for('admin_action') }}" style="display:inline;">
                  <input type="hidden" name="action" value="approve_item" />
                  <input type="hidden" name="item_id" value="{{ item.id }}" />
                  <button type="submit" class="btn btn-success btn-xs" style="font-weight:700;">âœ“ Approve & Publish</button>
                </form>
                <form method="POST" action="{{ url_for('admin_action') }}" style="display:inline;" onsubmit="return confirm('Delete this item?');">
                  <input type="hidden" name="action" value="reject_item" />
                  <input type="hidden" name="item_id" value="{{ item.id }}" />
                  <button type="submit" class="btn btn-danger btn-xs">âœ• Reject</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><div class="empty-icon">âœ…</div><h3>No pending items</h3><p>You're all caught up!</p></div>
      {% endif %}
    </div>

    <!-- Approved Items -->
    <div class="tab-panel card" id="tab-approved" role="tabpanel" aria-labelledby="btn-approved">
      {% if approved_items %}
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Item</th><th>Category</th><th>Location</th><th>Date Found</th><th>Actions</th></tr></thead>
          <tbody>
            {% for item in approved_items %}
            <tr>
              <td style="color:var(--white-40);">#{{ item.id }}</td>
              <td><strong style="color:var(--white);">{{ item.name }}</strong></td>
              <td><span class="badge badge-approved">{{ item.category }}</span></td>
              <td>{{ item.location }}</td>
              <td>{{ item.date_found }}</td>
              <td>
                <form method="POST" action="{{ url_for('admin_action') }}" style="display:inline;">
                  <input type="hidden" name="action" value="mark_claimed" />
                  <input type="hidden" name="item_id" value="{{ item.id }}" />
                  <button type="submit" class="btn btn-glass btn-xs">Mark Claimed</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><div class="empty-icon">ðŸ“­</div><h3>No live items</h3><p>Approve pending items to publish them.</p></div>
      {% endif %}
    </div>

    <!-- Claims -->
    <div class="tab-panel card" id="tab-claims" role="tabpanel" aria-labelledby="btn-claims">
      {% if pending_claims %}
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Item</th><th>Claimant</th><th>Email</th><th>Grade</th><th>Proof Score</th><th>Hidden Detail</th><th>Submitted</th><th>Actions</th></tr></thead>
          <tbody>
            {% for claim in pending_claims %}
            <tr>
              <td style="color:var(--white-40);">#{{ claim.id }}</td>
              <td><strong style="color:var(--white);">{{ claim.item_name }}</strong></td>
              <td>{{ claim.claimant }}</td>
              <td><a href="mailto:{{ claim.email }}" style="color:var(--accent);">{{ claim.email }}</a></td>
              <td>{{ claim.student_id }}</td>
              <td>
                {% set ps = claim.proof_score or 0 %}
                <span style="font-weight:700; color:{% if ps >= 60 %}var(--success){% elif ps >= 30 %}var(--warning){% else %}var(--error){% endif %};">
                  {{ ps }}/100
                </span>
              </td>
              <td style="max-width:200px; font-size:0.82rem; color:var(--white-70);">{{ claim.proof_detail or claim.message or 'â€”' }}</td>
              <td style="font-size:0.8rem;">{{ claim.submitted }}</td>
              <td style="display:flex; gap:6px;">
                <form method="POST" action="{{ url_for('admin_action') }}" style="display:inline;">
                  <input type="hidden" name="action" value="approve_claim" />
                  <input type="hidden" name="claim_id" value="{{ claim.id }}" />
                  <button type="submit" class="btn btn-success btn-xs">âœ“</button>
                </form>
                <form method="POST" action="{{ url_for('admin_action') }}" style="display:inline;">
                  <input type="hidden" name="action" value="reject_claim" />
                  <input type="hidden" name="claim_id" value="{{ claim.id }}" />
                  <button type="submit" class="btn btn-danger btn-xs">âœ•</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><div class="empty-icon">ðŸ“¬</div><h3>No pending claims</h3></div>
      {% endif %}
    </div>

    <!-- Claimed -->
    <div class="tab-panel card" id="tab-claimed" role="tabpanel" aria-labelledby="btn-claimed">
      {% if claimed_items %}
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Item</th><th>Category</th><th>Location</th><th>Date Found</th></tr></thead>
          <tbody>
            {% for item in claimed_items %}
            <tr>
              <td style="color:var(--white-40);">#{{ item.id }}</td>
              <td><strong style="color:var(--white);">{{ item.name }}</strong></td>
              <td><span class="badge badge-claimed">{{ item.category }}</span></td>
              <td>{{ item.location }}</td>
              <td>{{ item.date_found }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><div class="empty-icon">ðŸ“¦</div><h3>No claimed items yet</h3></div>
      {% endif %}
    </div>

    <!-- Notifications -->
    <div class="tab-panel card" id="tab-notifications" role="tabpanel" aria-labelledby="btn-notifs">
      {% if notifications %}
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>ID</th><th>Email</th><th>Keyword</th><th>Phone (SMS)</th><th>Created</th></tr></thead>
          <tbody>
            {% for n in notifications %}
            <tr>
              <td style="color:var(--white-40);">#{{ n.id }}</td>
              <td><a href="mailto:{{ n.email }}" style="color:var(--accent);">{{ n.email }}</a></td>
              <td><span class="badge badge-approved">{{ n.keyword }}</span></td>
              <td style="font-size:0.85rem;">
                {% if n.phone %}
                  <span style="color:var(--success);">ðŸ“± {{ n.phone }}</span>
                {% else %}
                  <span style="color:var(--white-20);">Email only</span>
                {% endif %}
              </td>
              <td style="font-size:0.8rem;">{{ n.created }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state"><div class="empty-icon">ðŸ””</div><h3>No alerts set up yet</h3><p>Students can sign up for alerts on the Browse page.</p></div>
      {% endif %}
    </div>

    <!-- SMS Log -->
    <div class="tab-panel card" id="tab-sms" role="tabpanel" aria-labelledby="btn-sms">
      {% if sms_logs %}
      <div style="margin-bottom:16px; font-size:0.82rem; color:var(--white-40);">Showing last 50 SMS alerts sent.</div>
      <div style="overflow-x:auto;">
        <table class="admin-table">
          <thead><tr><th>Time</th><th>To</th><th>Keyword</th><th>Email</th><th>Status</th><th>Message Preview</th></tr></thead>
          <tbody>
            {% for log in sms_logs %}
            <tr>
              <td style="font-size:0.78rem; color:var(--white-40); white-space:nowrap;">{{ log.sent_at }}</td>
              <td style="font-size:0.85rem; color:var(--white);">ðŸ“± {{ log.phone }}</td>
              <td>{% if log.keyword %}<span class="badge badge-approved">{{ log.keyword }}</span>{% else %}â€”{% endif %}</td>
              <td style="font-size:0.78rem; color:var(--accent);">{{ log.email or 'â€”' }}</td>
              <td>
                <span class="badge {% if log.status == 'sent' %}badge-approved{% else %}badge-pending{% endif %}">
                  {{ log.status }}
                </span>
              </td>
              <td style="font-size:0.75rem; color:var(--white-40); max-width:220px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="{{ log.message }}">
                {{ log.message[:80] }}â€¦
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <div class="empty-icon">ðŸ“±</div>
        <h3>No SMS alerts sent yet</h3>
        <p>SMS alerts fire automatically when an item is approved that matches a subscriber's keyword.</p>
      </div>
      {% endif %}
    </div>

  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  const tabBtns = document.querySelectorAll('.tab-btn');
  const panels  = document.querySelectorAll('.tab-panel');

  function openTab(controlId) {
    tabBtns.forEach(b => { b.classList.remove('active'); b.setAttribute('aria-selected','false'); });
    panels.forEach(p => p.classList.remove('active'));
    const btn = document.querySelector(`[aria-controls="${controlId}"]`);
    const panel = document.getElementById(controlId);
    if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
    if (panel) panel.classList.add('active');
  }

  tabBtns.forEach(btn => {
    btn.addEventListener('click', () => openTab(btn.getAttribute('aria-controls')));
  });

  // Auto-open the right tab based on server hint
  const activeTab = "{{ active_tab }}";
  const tabMap = { pending: 'tab-pending', approved: 'tab-approved', claims: 'tab-claims', claimed: 'tab-claimed', notifications: 'tab-notifications', sms: 'tab-sms' };
  if (tabMap[activeTab]) openTab(tabMap[activeTab]);
</script>
{% endblock %}
